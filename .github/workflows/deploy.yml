name: Deploy Spring Boot App

on:
  push:
    branches:
      - deploy

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Set up Java 21 with Maven
      uses: actions/setup-java@v5
      with:
        distribution: 'temurin' # Adoptium Temurin
        java-version: '21'
        cache: 'maven' # Maven 캐싱 활성화 (빌드 속도 향상)

    - name: Build Spring Boot Application
      run: mvn clean package -DskipTests # 테스트를 건너뛰고 Maven 빌드

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: spring-boot-jar
        path: target/ai-carebot-risk-detection-spring-0.0.1-SNAPSHOT.jar

  deploy-test:
    runs-on: ubuntu-latest
    needs: build
    environment: test

    steps:
    - name: Download build artifact
      uses: actions/download-artifact@v5
      with:
        name: spring-boot-jar
        path: ./spring-boot-jar # 다운로드 경로는 파일 그 자체 (디렉토리가 아님)

    - name: Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p ${{ secrets.SSH_PORT1 }} ${{ secrets.HOST }} >> ~/.ssh/known_hosts

    - name: Deploy via SSH
      run: |
        SERVER_USER="${{ secrets.USERNAME }}"
        SERVER_HOST="${{ secrets.HOST }}"
        SERVER_PORT="${{ secrets.SSH_PORT1 }}"
        DEPLOY_PATH="/home/deploy"
        APP_NAME="ai-carebot-risk-detection-spring-0.0.1-SNAPSHOT"
        JAR_FILE="$APP_NAME.jar"

        # 현재 시간으로 릴리스 폴더 생성 (예: /home/deploy/20231027103000)
        NEW_RELEASE_DIR="$DEPLOY_PATH/$(date +%Y%m%d%H%M%S)"
        
        # SCP로 JAR 파일 전송
        # 다운로드된 아티팩트가 './spring-boot-jar' 경로에 'my-spring-boot-app.jar' 형태로 존재한다고 가정
        scp -P $SERVER_PORT "./spring-boot-jar/$JAR_FILE" $SERVER_USER@$SERVER_HOST:/home/deploy/$JAR_FILE

        # SSH로 서버에 접속하여 배포 스크립트 실행
        ssh -p $SERVER_PORT $SERVER_USER@$SERVER_HOST << EOF
          mkdir -p $NEW_RELEASE_DIR
          mv /home/deploy/$JAR_FILE $NEW_RELEASE_DIR/$JAR_FILE
          echo "New release deployed to $NEW_RELEASE_DIR"

          # 심볼릭 링크 업데이트
          CURRENT_SYMLINK="$DEPLOY_PATH/current"
          ln -sfn $NEW_RELEASE_DIR $CURRENT_SYMLINK
          echo "Symlink updated to $CURRENT_SYMLINK"

          # 서비스 재시작 (Docker 컨테이너 내부에서 nohup 사용 시)
          # 기존 자바 프로세스 종료 (컨테이너 내에 Java 프로세스가 하나만 있다고 가정)
          pgrep -f "java -jar $APP_NAME.jar" | xargs kill -9 || true
          echo "Previous Java process killed."

          # 새로운 JAR 파일로 서비스 실행
          nohup /usr/bin/java -jar $CURRENT_SYMLINK/$JAR_FILE > $DEPLOY_PATH/logs/$APP_NAME.log 2>&1 &
          echo "New service started via nohup."
        EOF
