name: Deploy Spring Boot App

on:
  push:
    branches:
      - deploy

jobs:
  build:
    runs-on: ubuntu-latest
    environment: test

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Set up Java 21 with Maven
      uses: actions/setup-java@v5
      with:
        distribution: 'temurin'
        java-version: '21'
        cache: 'maven'

    - name: Build Spring Boot Application
      run: |
        mvn clean package -DskipTests

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: spring-boot-jar
        path: target/*.jar

  deploy-test:
    runs-on: ubuntu-latest
    needs: build
    environment: test

    steps:
    - name: Checkout repository for deploy script
      uses: actions/checkout@v5

    - name: Download build artifact
      uses: actions/download-artifact@v5
      with:
        name: spring-boot-jar
        path: ./spring-boot-jar

    - name: Get Downloaded Jar File Name
      id: get_jar_name
      run: |
        DOWNLOADED_PATH_FILE=$(find ./spring-boot-jar -name "*.jar" -print -quit)
        if [ -z "$DOWNLOADED_PATH_FILE" ]; then
          echo "Error: No JAR file found in ./spring-boot-jar"
          exit 1
        fi
        echo "JAR_FILENAME=$(basename "$DOWNLOADED_PATH_FILE")" >> $GITHUB_OUTPUT

    - name: Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p ${{ secrets.SSH_HOST1_PORT }} ${{ secrets.HOST1 }} >> ~/.ssh/known_hosts
        echo "SSH configuration complete on Runner."

    - name: Deploy using remote script
      run: |
        USERNAME="${{ secrets.USERNAME }}"
        HOST1="${{ secrets.HOST1 }}"
        SSH_HOST1_PORT="${{ secrets.SSH_HOST1_PORT }}"
        DEPLOY_PATH="${{ vars.DEPLOY_PATH }}"
        JAR_FILENAME="${{ steps.get_jar_name.outputs.JAR_FILENAME }}"
        
        DEPLOY_SCRIPT_PATH=".github/scripts/deploy.sh" 
        REMOTE_SCRIPT_PATH="$DEPLOY_PATH/deploy_script.sh"

        chmod +x "$DEPLOY_SCRIPT_PATH"

        echo "--- DEPLOY JOB: Transferring deploy script and JAR to remote server ---"
        
        # 1. 쉘 스크립트를 원격 서버로 전송
        scp -P $SSH_HOST1_PORT "$DEPLOY_SCRIPT_PATH" $USERNAME@$HOST1:$REMOTE_SCRIPT_PATH
        if [ $? -ne 0 ]; then echo "Error: Failed to transfer deploy script"; exit 1; fi

        # 2. JAR 파일을 원격 서버로 전송
        scp -P $SSH_HOST1_PORT "./spring-boot-jar/$JAR_FILENAME" $USERNAME@$HOST1:$REMOTE_SCRIPT_PATH
        if [ $? -ne 0 ]; then echo "Error: Failed to transfer JAR file"; exit 1; fi

        echo "--- DEPLOY JOB: Executing deploy script on remote server ---"
        # 3. 원격 서버에서 쉘 스크립트 실행 (인자 전달)
        ssh -p $SSH_HOST1_PORT $USERNAME@$HOST1 "bash \"$REMOTE_SCRIPT_PATH\" \"$DEPLOY_PATH\" \"$JAR_FILENAME\" \"${{ secrets.DB_URL }}\" \"${{ secrets.DB_USERNAME }}\" \"${{ secrets.DB_PASSWORD }}\""
        if [ $? -ne 0 ]; then echo "Error: Remote deploy script failed"; exit 1; fi
        
        echo "--- DEPLOY JOB END ---"
